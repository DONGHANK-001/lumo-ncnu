你是一位資深全端架構師（偏產品工程）＋DevOps＋資安意識強的工程主管。請全程使用「繁體中文」回覆，並以「可直接部署上線、功能正常、可擴展、易維護」為最高目標。

# 專案名稱
lumo-ncnu（平台名稱也叫 lumo-ncnu）

# 專案總目標
打造「校園運動配對平台」PWA MVP：
- 第一階段：只允許暨南大學（NCNU）學生使用
- 未來可開放校外使用（需預留設計與配置）
- 運動類型（第一版固定）：籃球、跑步、羽球、桌球、健身
- Free：免費使用核心配對/揪團
- PLUS：每月 20 元（第一版可先做訂閱狀態與 UI，不一定要串金流；需保留未來串金流的擴展點）
- 未來功能：學生教練媒合（後續再做），平台可抽成或收媒合費（預留資料結構與 API）

# 部署與分層（必須遵守）
- 前端（Frontend）：部署到 Vercel
- 後端（Backend API）：部署到 Render（Node.js）
- 登入（Auth）：Firebase Authentication（Google Sign-In）
- 資料庫（DB）：請選擇 PostgreSQL（建議 Render Postgres / Neon / Supabase 皆可），使用 Prisma ORM
- API 設計：REST（第一版），保留未來可演進成 GraphQL/更細服務
- 前後端分離：前端只透過後端 API 存取資料；前端不直接讀寫資料庫
- 權限控制：後端驗證 Firebase ID Token，且限制 email 網域（校內限定）

# 技術棧（建議且需一致）
## Frontend
- Next.js 14+（App Router）+ TypeScript
- UI：Tailwind CSS（簡潔、手機優先）
- 狀態：React state + minimal utilities（第一版不引入過重狀態管理）
- PWA：manifest + icons + service worker（next-pwa 或自行實作）
- API 呼叫：fetch + typed client（可用 zod 驗證回應）
- 部署：Vercel

## Backend
- Node.js + TypeScript
- Framework：Fastify 或 Express（擇一，需結構清晰）
- Prisma ORM + PostgreSQL
- 驗證：Firebase Admin SDK（verifyIdToken）
- 速率限制/安全：基本 rate limit、CORS、request validation
- 部署：Render（Web Service）

# 專案結構（必須清楚分類、可維護、可擴展）
你必須建立「單一 repo 的 monorepo」或「雙 repo」皆可，但要明確說明理由並提供最佳實務。
要求：清晰的資料夾分層、共用型別、環境變數、lint/format、commit 規範建議。
建議 monorepo 例：
/apps/web      (Next.js 前端)
/apps/api      (Node API 後端)
/packages/shared  (共用 types/zod schema/utils)
/packages/config  (eslint/tsconfig 共用)
但你可以提出更好的結構，需合理且能運作。

# 核心資料模型（至少要有）
- User（使用者）
  - id, firebaseUid, email, nickname, school, role, planType(Free/Plus), createdAt
  - preferences：sports[], skillLevel, availableTimes, usualLocations
- Group（揪團）
  - id, sportType, title, description, time, location, level, capacity, currentCount, createdBy, status, createdAt
- GroupMember（揪團成員）
  - groupId, userId, status(joined/waitlist/left), joinedAt
- Report（檢舉）
  - id, reporterId, targetType(user/group), targetId, reason, details, createdAt
- PlusSubscription（預留）
  - userId, status, startAt, endAt, provider(placeholder), planPrice=20
- CoachProfile（預留第二/三階段）
  - userId, sports, bio, price, availability, verificationStatus

# API 功能（第一版必做）
## Auth/Users
- GET /me：回傳使用者資料（需驗證 token）
- POST /profile：更新暱稱/偏好/程度/時段/地點（需驗證 token）
- POST /plan/upgrade：模擬升級 PLUS（第一版不串金流，後端把 planType 設為 PLUS；保留未來串金流的擴展點）

## Groups
- GET /groups：取得揪團列表（支援 query：sportType, level, dateRange, hasSlot）
- POST /groups：建立揪團
- GET /groups/:id：取得揪團詳情
- POST /groups/:id/join：加入
- POST /groups/:id/leave：退出
- POST /groups/:id/waitlist：候補（僅 PLUS；第一版可先功能可用但 UI 可簡化）

## Safety/Reports
- POST /reports：送出檢舉（需驗證 token）
- GET /safety：可用前端靜態，但後端可提供規範版本號（可選）

# 校內限定（第一階段強制）
- 後端必須檢查 Firebase token 中的 email
- 只允許 ALLOWED_EMAIL_DOMAIN（例如 ncnu.edu.tw；用環境變數設定）
- 不符合者回 403 + 明確錯誤碼（前端顯示「請使用暨南學生帳號登入」）

# 前端頁面（第一版必做，需功能可用）
- /（Landing）：價值主張 + CTA（/groups, /create）+ PWA 加入主畫面提示
- /login（或使用彈窗）：Firebase Google 登入（前端取得 ID Token）
- /groups：揪團列表（可篩選、可搜尋、可排序）
- /groups/[id]：揪團詳情（加入/退出/候補）
- /create：發起揪團（表單 + 即時預覽卡片）
- /profile：個人檔案（偏好設定 + 方案狀態）
- /pricing：Free vs PLUS（每月 20 元）+ 升級入口
- /safety：安全規範至少 8 條 + 檢舉入口（表單）

# AI 功能（此回合先不強制，但要預留擴展點）
- 第一版可先不接 Gemini/OpenAI
- 但要在後端預留 /ai/* 路由與 service layer，未來可加入：
  - 揪團文案優化
  - 配對建議
  - 破冰流程生成
（如果你願意也可直接實作，但必須不影響 MVP 上線）

# PWA（第一版必做）
- manifest（name/short_name/start_url/display/theme_color/icons 192/512）
- service worker（快取 Landing 與靜態資源，離線可開）
- iOS/Android 加入主畫面提示

# 安全與品質（必須）
- 前端不得存任何私密金鑰
- 後端使用 Firebase Admin 驗證 token
- CORS 僅允許前端域名（含 Vercel）
- Request validation（zod）
- Rate limit（至少對 auth-less endpoints）
- 錯誤處理統一格式（error code + message）
- Logging：基本 request log + error log
- 測試：至少對關鍵 service/route 做基本單元測試或整合測試（選擇性，但要給出可擴展測試架構）
- Lint/Format：ESLint + Prettier（前後端一致）

# 環境變數（必須提供 .env.example，且分 web/api）
## apps/web/.env.example
NEXT_PUBLIC_API_BASE_URL=
NEXT_PUBLIC_FIREBASE_API_KEY=
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=
NEXT_PUBLIC_FIREBASE_PROJECT_ID=
NEXT_PUBLIC_FIREBASE_APP_ID=
NEXT_PUBLIC_FIREBASE_MEASUREMENT_ID=（可選）
ALLOWED_EMAIL_DOMAIN=（前端可用於顯示提示，不作為安全判斷）

## apps/api/.env.example
PORT=4000
DATABASE_URL=
FIREBASE_PROJECT_ID=
FIREBASE_CLIENT_EMAIL=
FIREBASE_PRIVATE_KEY=
ALLOWED_EMAIL_DOMAIN=
CORS_ORIGINS=（以逗號分隔，含 Vercel 網址與 localhost）

# 部署要求（必須提供步驟）
- Vercel 部署 web：設定 web env、連 Git、產生網址
- Render 部署 api：設定 api env、啟動指令、健康檢查 endpoint（/health）
- DB：提供 migration 指令（prisma migrate deploy）
- Firebase：建立專案、啟用 Google Sign-in、設定 Authorized domains（含 vercel.app、你的自訂網域如有）

# 交付格式（請嚴格遵守）
1) 先列出整體架構與資料夾樹（monorepo 或雙 repo）
2) 再逐一提供所有關鍵檔案完整程式碼（可複製貼上即可跑）
   - 前端：Next.js pages/app router、Firebase init、auth hooks、API client、各頁面
   - 後端：server 啟動、routes、middlewares、firebase admin verify、prisma schema、migrations 指令、error handler
   - shared：types、zod schema（若採 monorepo）
3) 提供本機啟動步驟（dev）
4) 提供部署步驟（Vercel + Render + DB）
5) 提供「上線前檢查清單」（安全、環境變數、CORS、token 驗證、domain 限制）
6) 確保功能可用：登入、建立揪團、列表、詳情、加入/退出、個人檔案更新、PLUS 模擬升級、候補（PLUS）

現在開始建立專案，先給我檔案樹與架構決策（monorepo 或雙 repo）並說明原因，接著輸出完整程式碼。
